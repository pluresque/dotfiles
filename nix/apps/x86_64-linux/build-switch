#!/bin/sh -e

GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
NC='\033[0m'

# Parse --host argument
HOST=""
OTHER_ARGS=""

while [ $# -gt 0 ]; do
  case "$1" in
    --host=*)
      HOST="${1#*=}"
      shift
      ;;
    --host)
      HOST="$2"
      shift 2
      ;;
    *)
      OTHER_ARGS="$OTHER_ARGS $1"
      shift
      ;;
  esac
done

if [ -z "$HOST" ]; then
  echo -e "${RED}Usage: build-switch --host <hostname>${NC}"
  echo -e "  Available hosts: pluresque-desktop, pluresque-homelab"
  exit 1
fi

echo -e "${YELLOW}Building for host: $HOST${NC}"
echo -e "${YELLOW}Starting...${NC}"

sudo /run/current-system/sw/bin/nixos-rebuild switch --flake .#"$HOST" $OTHER_ARGS

echo -e "${GREEN}Switch to new generation complete!${NC}"
